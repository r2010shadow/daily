# 虚拟机迁移

## 虚拟机创建方法：

1. 创建空虚拟机
2. 虚拟机克隆虚拟机：虚拟机运行状态是可以克隆虚拟机的
3. 按照模板部署虚拟机：模板存在，可以调整参数，批量部署
4. 模板转为虚拟机：模板不存在，不能调整参数
5. 导入/导出虚拟机：

- 一个OVF和N个VHD文件，OVF为虚拟机配置描述文件，VHD为华为虚拟机硬盘文件
- OVA，OVF和VHD导出压缩为1个OVA文件

## 虚拟机模板制作：

前提：关闭虚拟机，作用：批量部署虚拟机。

1. 将虚拟机转为模板
2. 将虚拟机克隆为模板（可改硬件配置）
3. 将模板克隆为模板（可改硬件配置）
4. 导入\导出模板

## 安装TOOLS：

### TOOLS功能：

1. 提高性能：网络IO、磁盘IO
2. 监控功能：CPU、内存、磁盘使用量、IP地址
3. 高级功能：
   - 安全关闭、重启或休眠虚拟机
   - 创建虚拟机快照
   - 迁移虚拟机
   - 在线调整CPU规格
   - 与主机时间同步
   - 虚拟机网卡的高级功能：QOS、ARP广播抑制、DHCP隔离
   - 自动升级虚拟机驱动程序

### 安装TOOLS：

1. Windows：挂载光驱，以管理员身份运行

2. Linux：

   1. 使用root身份安装

      ```shell
      sudo -i
      #可以切换到root
      #只需要提供普通用户密码
      ```

   2. 挂载TOOLS

      ```shell
      lsblk
      #查看当前所有块设备
      mount /dev/sr0 /mnt
      #将光驱sr0挂载到/mnt
      mkdir /pvdrirver
      tar xvf  vmtoolXXXXX.tar.bz2 -C /pvdriver 
      cd /pvdirver/vmtools/
      ./install
      reboot
      ```

### 虚拟机删除：

- 普通删除
- 安全删除
- 延后删除并可以还原

### [快照](https://www.cnblogs.com/shanheoldman/p/16504868.html#https://support.huawei.com/enterprise/zh/doc/EDOC1100196336)[详细点击快照]：

快照原理：

- ROW：被称之为写时重定向。ROW 的实现原理与 COW 非常相似，区别在于ROW 对原始数据卷的首次写操作，会将新数据重定向到预留的快照卷中。所以，ROW 快照中的原始数据依旧保留在源数据卷中，并且为了保证快照数据的完整性，在创建快照时，源数据卷状态会由读写变成只读的
- COW：被称为即写即拷快照技术或写时拷贝快照技术，当主机将数据第一次写入到存储某个位置时，首先将原有的位置的内容读取，写到COW数据空间，然后将新数据写入到存储设备中。而下次主机针对这一位置的写操作将不再执行写时拷贝。这种实现方式在首次写入时需要完成一个读操作（读取源位置的数据），两个写操作（写原位置和写快照预留空间）。如果写入频繁，那么这种方式将非常消耗I/O操作。因此可以推断，当某个LUN上的I/O多数以读操作为主，写操作较少时，可以采用COW快照技术。另外，如果一个应用易出现写入热点，即只针对某个有限范围内容的数据进行写操作，那么也可以采用COW快照技术，因为同一份数据的多次写操作只会出现一次写时拷贝。

### 限制：

一台虚拟机最多可创建32个快照，首次创建时间较长，后续创建的快照为2次快照之间的差异部分，删除中间节点快照，快照进行下一节点的合并工作。

### 快照分类：

- 普通快照：磁盘快照
- 一致性快照：磁盘快照和内存快照的结合，在留快照的时候先把内存中的缓存数据刷到磁盘中，再进行磁盘快照，避免数据丢失，且速度较快。
- 内存快照：虚拟机开机状态下，保留磁盘和内存昕。
  1. 集群开启内存复用时虚拟机不允许创建内存快照。
  2. 虚拟机运行状态下可以做内存快照，但内存快照存在一些限制，比如虚拟机必须运行状态，Pv driver必须运行，OS限制等。
  3. 根据其说明排查，虚拟机未绑定共享磁盘，且虚拟机中的磁盘均支持快照（虚拟化存储上的磁盘，受快照影响，持久化磁盘）。

### 快照应用进阶：

虚拟机的快照 保存虚拟机设置和虚拟机磁盘的数据，用于虚拟机数据的还原和恢复。如果创建内存快照，还可以保存和恢复虚拟机的内存状况。

当虚拟机处于已停止状态时，不能勾选“内存快照”和“一致性快照”，创建的快照为磁盘快照，仅将与该虚拟机绑定的磁盘模式为“从属”的磁盘当前数据进行保存。 当虚拟机处于运行中状态时，若勾选“内存快照”，则快照创建时会保存虚拟机当前内存中的数据。 当虚拟机处于运行中状态时，若勾选“一致性快照”，则快照创建时会将虚拟机当前未保存的缓存数据先保存，再创建快照。 当虚拟机处于已休眠状态时，默认勾选“内存快照”，虚拟机只能生成内存快照。 “内存快照”和“一致性快照”无法同时创建。当界面默认勾选“一致性快照”时，如需创建“内存快照”，请先取消勾选“一致性快照”， 当虚拟机在进行如下操作时，不能进行虚拟机内存快照创建操作。

- 热迁移；
- 在线增加CPU；
- 重启或关机。

当一主机内有虚拟机在创建内存快照时，该主机上的其他虚拟机不能同时创建内存快照。如同时创建，则系统按照快照创建的先后顺序依次逐个执行任务。 仅当满足以下要求时，虚拟机支持一致性快照：

- 虚拟机没有绑定共享磁盘。
- 虚拟机已安装Tools，且Tools运行正常。
- 虚拟机磁盘的存储类型为虚拟化本地硬盘、虚拟化SAN、FusionStorage Block或NAS存储

仅当满足以下要求时，虚拟机支持内存快照：

- 虚拟机没有绑定共享磁盘。
- 虚拟机中的磁盘均支持快照。

### 运维和管理

维护：

日常运维
每天
1、系统告警
2、检查FusionCompute健康检查
3、检查设备运行状态
每周
4、检查设备运行环境
温湿度、空气质量
每月
[访问地址](https://support.huawei.com/enterprise/zh/index.html)，选择“公告 > 产品公告 > 预警公告 > IT > 云计算数据中心 > FusionSphere > FusionSphere”，查看预警整改公告。

告警：紧急、提示、重要、次要

事件：告警事件

性能：

- 单对象多指标：单台主机的CPU、内存、网络流量的分析
- 多对象多指标：多台主机的CPU、内存、网络流量的分析

配置管理：告警事件的消除

用户管理：

1. 本地用户：RABC、基于角色的权限控制
2. 域用户：LDAP Server身份认证服务器，现有环境中存在域控服务器
3. 接口用户：桌面云对接等账户

### 备份与恢复策略：

- 自动备份：每天凌晨2点，默认保留备份7天，保持到/var/backup

- 手工备份：备份到FTP服务器，本地备份到/var/backup/manual，然后配置FTP的账号和密码

  系统默认在每日凌晨02:00自动进行备份。
  系统默认每小时第30分钟备份管理数据 (不包括监控数据)到VRM节点的/var/backup/manual/目录。若没有可使用的第三方备份服务器，也可以选择配置一个主机，系统每小时自动将此管理数据拷贝到主机的“/opt/backupdb”目录下。主机上最多只保留一天的数据。
  系统默认在每月1日取最新的自动备份文件进行月备份，最多保存2份备份文件，即本月1日的自动备份文件和上月1日的自动备份文件。
  本地自动备份和手工备份文件未超过最多保留份数时，新备份文件不覆盖旧备份文件；超过最多保留份数时，系统会自动清理创建时间最早的备份文件。
  若存在可使用的第三方备份服务器，则开启第三方备份后，在完成本地自动与手工备份后FusionCompute会自动将备份文件上传到第三方服务器。
  当第三方备份服务器上的备份文件未超过最多保留份数时，新备份文件不覆盖旧备份文件；超过最多保留份数时，系统会自动清理创建时间最早的备份文件。

```bash
手工备份
自动备份
	1、凌晨2：00备份
	本地备份默认7份
	第三方备份保留30份
	/var/backup
VRM虚拟化部署
VNC登录
用户名：root
密码：Iaas@OS-CLOUD8!
SSH登录
用户名：gandlf
密码：Iaas@OS-CLOUD9！
CNA登录
SSH登录
用户名：gandlf
密码：Iaas@OS-CLOUD9！
VNC登录
用户名：root
密码：创建时的密码
FTP：10.20.0.170
ftp/Huawei12#$
```

## 迁移

### 迁移场景分类：

华为内部虚拟化平台迁移：集群内的虚拟机在不同的物理主机的迁移

P2V：物理主机迁移到虚拟化平台【重点为本部分】

V2V：从VMware等第三方虚拟化环境迁移到华为的虚拟化平台，需要在迁移环节中卸载原虚拟化的驱动PV Driver，安装华为的tools。

## 华为内部虚拟化迁移：

### 迁移分类：

- 热迁移：
  - 基于虚拟机
    - 更改主机
    - 更改数据存储：存储整体迁移、按磁盘迁移
    - 更改主机和数据存储
  - 基于存储：数据存储-迁移磁盘
- 冷迁移：基于虚拟机，只能选择更改数据存储，可以存储整体迁移、按磁盘迁移，关闭状态的虚拟机不属于集群内的任何主机，所以无法更改主机。

### 迁移流程：

1. 迁移：源主机迁移 到目标虚拟机
2. 测试验证：验证迁移后的系统可以正常工作
3. 增量同步：将源主机迁移的新增数据同步至目的虚拟机
4. 业务切换：最后一次业务同步后将业务迁移至目的虚拟机

### 热迁移过程：

1. 在源和目的主机之间建立连接
2. 传输虚拟机的设备信息和配置信息，设备信息包括CPU、内存、网卡、磁盘容量，配置信息包括虚拟机的操作系统、引导方式
3. 传输虚拟机的内存
4. 暂停（挂起）源虚拟机传送状态，选择最后一次数据同步
5. 目标虚拟机卸载原虚拟化驱动，安装TOOLS，恢复业务

### 热迁移使用技术：

内存：内存分片+迭代迁移

存储：Mirror IO+迭代迁移

### 热迁移前提条件：

1. 虚拟化要求：
   - 虚拟机处于运行状态
   - 虚拟机已安装TOOLS，且TOOLS运行状态正常
   - 虚拟机与主机处于未绑定状态，虚拟机未绑定主机未绑定USB设备、图形处理器、裸设备映射、网卡等硬件设备
2. 计算资源要求：
   - 目标主机不能处于维护模式
   - 目标主机有足够的资源、CPU和内存
   - 迁移过程中，不能对源主机和目标主机进行下电或重启
   - 如果源主机和目的主机CPU类型不一致，需要开启集群IMC
   - 当跨集群迁移时，源主机和目标所属的集群内存复用开关必须相同
3. 存储资源要求：
   - 源主机和目的主机均能访问虚拟机所在磁盘，虚拟机所属的数据存储必须同时关联源主机和业务主机
4. 网络要求：
   - 源主机和目标主机网络必须互通。即虚拟机网卡所属的端口组所在的分布式交换机上行链路必须关联源主机和目标主机

### 存储热迁移限制条件：

1. 不支持跨FusionStorage存储之间进行热迁
2. 不支持已经挂载总线类型为“IDE”的磁盘
3. 不支持带有快照的磁盘迁移
4. 不支持已经挂载“共享”磁盘和链接克隆虚拟的虚拟机【非持久化磁盘】

### 热迁移应用场景：

服务器维护，集群内迁移运行在主机上的虚拟机。

DRS、DPM、规则组

### 常见问题：

1. 迁移使用快照技术了吗？没有

2. 热迁移有没有中断时间？有，终端1-2个数据包

3. 热迁移流量走那个网络？

   默认使用管理平面网络，走管理接口。可以通过主机-配置-网络-逻辑接口-添加业务管理接口（热迁、心跳、容灾）。

4. VRM虚拟机可不可以迁移？

   不可以，做了主机绑定

5. 能不能跨集群迁移？

   可以，需要两个集群使用相同DVS，相同的共享存储。

## 跨平台迁移：

### 数据迁移手段：

| 序号 | 支持迁移模式 | 迁移手段   | 停机时间                         | 迁移所需资源       | 异构支持 | 实施难度   |
| ---- | ------------ | ---------- | -------------------------------- | ------------------ | -------- | ---------- |
| 1    | 在线、离线   | 数据库层   | 2-3小时，实际视日志文件大小而定  | 占用较高网络带宽   | 支持     | 中         |
| 2    | 在线、离线   | 文件系统层 | 全量恢复3-4小时，增量恢复1-2小时 | 占用主机及备份资源 | 不支持   | 中         |
| 3    | 在线         | 逻辑卷层   | 约1小时                          | 占用主机及存储资源 | 不支持   | 中         |
| 4    | 在线、离线   | 光纤层     | 约15分钟                         | 占用主机及存储资源 | 支持     | 低         |
| 5    | 在线         | 存储层     | 约20分钟                         | 占用存储资源       | 不支持   | 需复制许可 |



### 迁移评估基本步骤（目的端为虚拟化平台）：

#### 迁移调研：

1. #### 业务调研：

   业务系统调研，业务系统部署模式，信息，业务系统间关联性，待迁移业务系统的功能

2. #### 评估调研：

   - 信息收集：

     1.源端、目的端平台版本

     2.代迁移主机操作系统类型

     3.待迁移主机（Linux）的OS内核版本

     4.待迁移主机（Windows）的OS是否OEM类型

     5.待迁移主机的磁盘类型、启动方式

     6.待迁移主机的业务类型/描述

     7.待迁移主机的业务负载

   - 可虚拟化评估：

     - 业务类型是否适合虚拟化部署
     - OS类型/内核版本是否在目的平台的兼容性列表
     - 不适合虚拟化部署的场景：
       1. 物理服务器非X86架构
       2. 应用程序需要高性能、图片处理
       3. 应用程序需要特殊的硬件支持
       4. 应用程序需要特殊的USB设备链接后才能使用
       5. 运行在高配置的物理服务器且资源利用率高
       6. 虚拟化平台不兼容的操作系统
       7. License要求

   - 迁移可行性评估：

     1.源目的端平台是否在工具兼容性列表

     2.待迁移主机OS类型是否在工具兼容性列表

     3.待迁移主机是否满足工具的约束条件

     4.业务类型是否适合施工工具迁移

   - 风险评估：

     业务场景复杂、停机时间、费用、操作复杂程度

3. #### 规划设计

4. #### 迁移测试

   - 应急预案演练
   - 测试迁移工具
   - 性能测试
   - 压力测试
   - 业务功能测试
   - 系统连接性能测试

5. #### 迁移实施

   - 数据备份
   - 迁移工具安装
   - 系统迁移
   - 系统验证测试
   - 数据同步
   - 数据验证测试
   - 源数据备份

6. #### 验收

   - 互联互通验证
   - 功能性验证
   - 性能验证

### 华为迁移工具：

Rainbow:操作系统迁移工具

#### Rainbow hConvertor：

定位：支持主流虚拟化平台和物理服务器向华为虚拟化平台迁移，反之不支持。支持X86架构系统迁移。

业务场景：P2V,V2V

优势：支持在线迁移，支持多种Windows和Linux系统的物理机或虚拟机迁移，支持并发迁移任务，支持断点续传【Linux文件迁移不要开启，容易中断】，支持多次数据同步，保持数据一致

#### Rainbow ovfConvertor：

离线镜像转换、目前已停止更新

#### 系统迁移技术：

- windows迁移 推荐块级迁移 使用Vss卷影复制服务

   文件级迁移 使用VSS+CIFS[文件共享协议]+Fast Copy

- Linux系统迁移

  推荐文件迁移 使用tar，ssh，rsync，利用rsync可以排除不需要迁移的文件

  块级迁移 使用DD+SSH

#### 迁移方式：

文件级迁移：

- 支持分区大小调整
- 按目录排除不需要迁移的文件，只迁移有效数据
- 如果硬盘分区远远大于实际使用大小，推荐使用文件级迁移

块级迁移：

- 速度相对快
- 分区结构和源端保持一致
- 分区大小和磁盘大小比较接近

#### 影响迁移效率主要因素：

网络带宽和质量、磁盘IO、数据量大小、源/目的主机性能

#### 迁移导致的业务中断：

最后一次数据增量同步时间+业务切换时间。建议：业务切换尽量在业务低峰期

#### 迁移兼容性：

#### 源虚拟机配置要求

#### 迁移原理

#### 迁移的约束条件

- 网络约束

  仅支持局域网迁移， 不支持广域网、 NAT 网络迁移

  仅支持私有云迁移，不支持公有云迁移、 桌面云迁移

  迁移实施要求网络无丢包、 无抖动、延迟<2ms、 宽带>100Mbps， 如不满足此 QOS 要求， 则迁移失败风险较高

#### 迁移过程简述：

下载迁移软件，新建迁移主机，安装迁移软件，运行OPENXXXX.bat，自动打开文件夹，将安装目录下的文件与运行脚本打开的文件夹中文件进行替换。

目的虚拟机的备注中写明Rainbow，按照正常配置要求创建裸虚拟机，需要预留一个临时IP地址在迁移过程中写入。

运行迁移软件，检测源主机，迁移配置信息，最后一次数据同步，卸载原虚拟化平台的驱动，安装华为工具。

```yaml
\1. 部署 Rainbow 服务器，服务器端发放 80、8443 和开启共享端口 137、138、139、445端口，以及自定义端口（例如 80 转发 8445，则发放 8445）。

\2. 导入 License。

\3. 对接云平台，配置目的端环境和共享目录（不能不创建共享目录）（对接目的：自动创建 VM。IP 自启动）。

\4. 对接源端，如果是 Windows 发放 8899 端口并安装 hcConvertor Agent（在安装完后默认监听 8899），还有 137-139，445（当 8899 没有开启时，通过 445 传递直接安装agent，如果业务安全敏感，禁用了 445 就直接把 agent 安装包拷贝到源端安装）；如果是 Linux 发放 22 端口为了 SSH（默认端口可以修改）。

\5. 创建目的虚拟机，启动虚拟机并挂载 Rainbow 共享出来的 LiveCD.iso 文件，并配置为光驱启动，配置临时 IP 地址

\6. 系统迁移，测试系统是否可用（系统迁移使用的技术：tar 归档+ssh 传递）

\7. n 次增量迁移(n>=0)

\8. 停止源端业务

\9. 离线迁移

\10. 进行离线同步

最后一次离线同步

\11. 禁用源主机网卡

\12. 改为硬盘启动

\13. 启动目的虚拟机、检测

\14. 如果是 v2v，则卸载旧的 Tools

\15. 安装 FusionCompute Tools

\16. 配目的端 IP

\17. 上线业务
```

---

原文链接：https://www.cnblogs.com/shanheoldman/p/16504868.html
